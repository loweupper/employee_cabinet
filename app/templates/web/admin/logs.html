<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã - Employee Cabinet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        {% include "components/sidebar.html" %}

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            {% include "components/header.html" %}

            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Page Header -->
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
                    <p class="text-gray-600 mt-2">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Å–æ–±—ã—Ç–∏–π —Å–∏—Å—Ç–µ–º—ã</p>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <form method="get" action="/admin/logs" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Search -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üîç –ü–æ–∏—Å–∫
                                </label>
                                <input 
                                    type="text" 
                                    name="search" 
                                    value="{{ search_query }}"
                                    placeholder="request_id, email, IP..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                            </div>

                            <!-- Level Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üìä –£—Ä–æ–≤–µ–Ω—å
                                </label>
                                <select 
                                    name="level" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                                    <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
                                    {% for lvl in log_levels %}
                                    <option value="{{ lvl }}" {% if current_level == lvl %}selected{% endif %}>
                                        {{ lvl }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Event Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üéØ –°–æ–±—ã—Ç–∏–µ
                                </label>
                                <select 
                                    name="event" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                                    <option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>
                                    {% for evt in unique_events %}
                                    <option value="{{ evt }}" {% if current_event == evt %}selected{% endif %}>
                                        {{ evt }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- HTTP Method Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üåê HTTP –ú–µ—Ç–æ–¥
                                </label>
                                <select 
                                    name="http_method" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                                    <option value="">–í—Å–µ –º–µ—Ç–æ–¥—ã</option>
                                    {% for method in unique_methods %}
                                    <option value="{{ method }}" {% if current_http_method == method %}selected{% endif %}>
                                        {{ method }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Date From -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üìÖ –î–∞—Ç–∞ –æ—Ç
                                </label>
                                <input 
                                    type="date" 
                                    name="date_from" 
                                    value="{{ date_from }}"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                            </div>

                            <!-- Date To -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üìÖ –î–∞—Ç–∞ –¥–æ
                                </label>
                                <input 
                                    type="date" 
                                    name="date_to" 
                                    value="{{ date_to }}"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                            </div>

                            <!-- User ID -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üë§ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                </label>
                                <input 
                                    type="number" 
                                    name="user_id" 
                                    value="{{ current_user_id if current_user_id else '' }}"
                                    placeholder="1"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                            </div>

                            <!-- Per Page -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üìÑ –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                                </label>
                                <select 
                                    name="per_page" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
<div class="flex gap-3">
    <button 
        type="submit" 
        class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
    >
        üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
    </button>
    <a 
        href="/admin/logs" 
        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
    >
        ‚ùå –°–±—Ä–æ—Å–∏—Ç—å
    </a>
    <a 
        href="/admin/logs/export?{{ request.url.query }}" 
        class="ml-auto px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
    >
        üì• –≠–∫—Å–ø–æ—Ä—Ç CSV
    </a>
    <a 
        href="/admin/logs/export/json?{{ request.url.query }}" 
        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
    >
        üì• –≠–∫—Å–ø–æ—Ä—Ç JSON
    </a>
</div>
                    </form>
                </div>

                <!-- Stats -->
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                    <p class="text-gray-600">
                        –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: <strong class="text-indigo-600">{{ total_logs }}</strong> | 
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞: <strong>{{ page }}</strong> –∏–∑ <strong>{{ total_pages }}</strong>
                    </p>
                </div>

                <!-- Logs Table -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–í—Ä–µ–º—è</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–£—Ä–æ–≤–µ–Ω—å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°–æ–±—ã—Ç–∏–µ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Request ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ú–µ—Ç–æ–¥</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ü—É—Ç—å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–í—Ä–µ–º—è (–º—Å)</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for log in logs %}
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="px-4 py-3 text-sm text-gray-900">{{ log.id }}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        {{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </td>
                                    <td class="px-4 py-3">
                                        {% if log.level.value == 'DEBUG' %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700">
                                            {{ log.level.value }}
                                        </span>
                                        {% elif log.level.value == 'INFO' %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-700">
                                            {{ log.level.value }}
                                        </span>
                                        {% elif log.level.value == 'WARNING' %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-700">
                                            {{ log.level.value }}
                                        </span>
                                        {% elif log.level.value == 'ERROR' %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">
                                            {{ log.level.value }}
                                        </span>
                                        {% elif log.level.value == 'CRITICAL' %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-600 text-white">
                                            {{ log.level.value }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">
                                        {{ log.event }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600 font-mono text-xs">
                                        {% if log.request_id %}
                                        <span class="truncate block max-w-[100px]" title="{{ log.request_id }}">
                                            {{ log.request_id[:8] }}...
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        {% if log.http_method %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded bg-indigo-100 text-indigo-700">
                                            {{ log.http_method }}
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600 font-mono text-xs">
                                        {% if log.http_path %}
                                        <span class="truncate block max-w-[150px]" title="{{ log.http_path }}">
                                            {{ log.http_path }}
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        {% if log.http_status %}
                                        {% if log.http_status < 300 %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">
                                            {{ log.http_status }}
                                        </span>
                                        {% elif log.http_status < 400 %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-700">
                                            {{ log.http_status }}
                                        </span>
                                        {% elif log.http_status < 500 %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-700">
                                            {{ log.http_status }}
                                        </span>
                                        {% else %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">
                                            {{ log.http_status }}
                                        </span>
                                        {% endif %}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        {% if log.duration_ms %}
                                        {{ log.duration_ms }} –º—Å
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        {% if log.user_email %}
                                        <span title="ID: {{ log.user_id }}">{{ log.user_email }}</span>
                                        {% elif log.user_id %}
                                        ID: {{ log.user_id }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600 font-mono text-xs">
                                        {{ log.ip_address or '-' }}
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <button 
                                            onclick="showLogDetail({{ log.id }})"
                                            class="text-indigo-600 hover:text-indigo-800 font-medium"
                                        >
                                            üëÅÔ∏è –î–µ—Ç–∞–ª–∏
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                {% if total_pages > 1 %}
                <div class="mt-6 flex justify-center">
                    <nav class="flex gap-2">
                        {% if page > 1 %}
                        <a href="?page={{ page - 1 }}&per_page={{ per_page }}&level={{ current_level or '' }}&event={{ current_event or '' }}&http_method={{ current_http_method or '' }}&search={{ search_query }}&date_from={{ date_from or '' }}&date_to={{ date_to or '' }}&user_id={{ current_user_id or '' }}" 
                           class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                        </a>
                        {% endif %}

                        <span class="px-4 py-2 bg-indigo-600 text-white rounded-lg">
                            {{ page }}
                        </span>

                        {% if page < total_pages %}
                        <a href="?page={{ page + 1 }}&per_page={{ per_page }}&level={{ current_level or '' }}&event={{ current_event or '' }}&http_method={{ current_http_method or '' }}&search={{ search_query }}&date_from={{ date_from or '' }}&date_to={{ date_to or '' }}&user_id={{ current_user_id or '' }}" 
                           class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            –°–ª–µ–¥—É—é—â–∞—è ‚Üí
                        </a>
                        {% endif %}
                    </nav>
                </div>
                {% endif %}
            </main>
        </div>
    </div>

    <!-- Modal for Log Details -->
    <div id="logDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">üìã –î–µ—Ç–∞–ª–∏ –ª–æ–≥–∞</h3>
                <button onclick="closeLogDetail()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="logDetailContent" class="p-6">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        function showLogDetail(logId) {
            fetch(`/admin/logs/${logId}/detail`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('logDetailContent').innerHTML = `
                        <div class="space-y-4">
                            <div><strong>ID:</strong> ${data.id}</div>
                            <div><strong>–í—Ä–µ–º—è:</strong> ${data.created_at}</div>
                            <div><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> <span class="px-2 py-1 rounded bg-blue-100">${data.level}</span></div>
                            <div><strong>–°–æ–±—ã—Ç–∏–µ:</strong> ${data.event}</div>
                            <div><strong>Request ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded">${data.request_id || '-'}</code></div>
                            ${data.message ? `<div><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${data.message}</div>` : ''}
                            ${data.http_method ? `<div><strong>HTTP –ú–µ—Ç–æ–¥:</strong> ${data.http_method}</div>` : ''}
                            ${data.http_path ? `<div><strong>HTTP –ü—É—Ç—å:</strong> <code class="bg-gray-100 px-2 py-1 rounded">${data.http_path}</code></div>` : ''}
                            ${data.http_status ? `<div><strong>HTTP –°—Ç–∞—Ç—É—Å:</strong> ${data.http_status}</div>` : ''}
                            ${data.duration_ms ? `<div><strong>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> ${data.duration_ms} –º—Å</div>` : ''}
                            ${data.user_email ? `<div><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${data.user_email} (ID: ${data.user_id})</div>` : ''}
                            ${data.ip_address ? `<div><strong>IP-–∞–¥—Ä–µ—Å:</strong> ${data.ip_address}</div>` : ''}
                            ${data.user_agent ? `<div><strong>User-Agent:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-xs">${data.user_agent}</code></div>` : ''}
                            ${data.extra_data ? `
                                <div>
                                    <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong>
                                    <pre class="bg-gray-100 p-4 rounded mt-2 text-xs overflow-x-auto">${JSON.stringify(data.extra_data, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('logDetailModal').classList.remove('hidden');
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ª–æ–≥–∞');
                    console.error(error);
                });
        }

        function closeLogDetail() {
            document.getElementById('logDetailModal').classList.add('hidden');
        }

        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLogDetail();
            }
        });
    </script>
</body>
</html>